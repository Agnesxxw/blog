(window.webpackJsonp=window.webpackJsonp||[]).push([[158],{702:function(t,s,a){"use strict";a.r(s);var n=a(12),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("blockquote",[a("p",[t._v("一致哈希是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对 K/n 个关键字重新映射，其中 K 是关键字的数量，n 是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。")])]),t._v(" "),a("p",[t._v("— 维基百科")]),t._v(" "),a("h2",{attrs:{id:"应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用场景"}},[t._v("#")]),t._v(" 应用场景")]),t._v(" "),a("p",[t._v("多用于分布式 Web 服务中。每个服务代表哈希环的一个节点，当此节点发生改变时候，例如挂掉，只有部分缓存会重新计算分布，而不是全部失效。")]),t._v(" "),a("p",[t._v("特性如下：")]),t._v(" "),a("ul",[a("li",[t._v("冗余少")]),t._v(" "),a("li",[t._v("负载均衡")]),t._v(" "),a("li",[t._v("过渡平滑")]),t._v(" "),a("li",[t._v("存储均衡")]),t._v(" "),a("li",[t._v("关键词单调")])]),t._v(" "),a("h2",{attrs:{id:"算法过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#算法过程"}},[t._v("#")]),t._v(" 算法过程")]),t._v(" "),a("p",[t._v("假设我们目前有一个缓存集群，图中 node 代表集群节点。")]),t._v(" "),a("p",[t._v("下图就是哈希环，区间范围是 0 ~ 2^32，所有的值都会被 hash 过来（比如采用 hashcode 算法）。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://secure-static.wolai.com/static/ucc3ucR5PmkqRWpK2H4f1T/image.png",alt:""}})]),t._v(" "),a("p",[t._v("读取缓存的步骤：")]),t._v(" "),a("ul",[a("li",[t._v("计算 node 哈希值，将其映射到 0 ~ 2^32 范围内")]),t._v(" "),a("li",[t._v("读取缓存时，计算缓存键对应的哈希值，映射到同一个圆上")]),t._v(" "),a("li",[t._v("顺时针查找圆，遇到的第一个 node")]),t._v(" "),a("li",[t._v("其上读取缓存，如果没有，那么更新缓存")])]),t._v(" "),a("p",[t._v("更新缓存步骤：类似「读取缓存」")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://secure-static.wolai.com/static/uc8a4kECeKQrJLVCcSEoVN/image.png",alt:""}})]),t._v(" "),a("p",[t._v("当 node 失效时，或者新加 node 时，只会有一部分缓存会变动，如上所示。")]),t._v(" "),a("h2",{attrs:{id:"数据倾斜问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据倾斜问题"}},[t._v("#")]),t._v(" 数据倾斜问题")]),t._v(" "),a("p",[t._v("如果服务节点太少，假设上图中，只有 node1 和 node3，那么大多数的缓存会落到 node1。")]),t._v(" "),a("p",[t._v("解决方法：每个 node，生成对应随机的 node 节点即可。")]),t._v(" "),a("p",[t._v("例如 node1 生成 node1#1、node1#2；node2 生成 node2#1、node2#2。")]),t._v(" "),a("h2",{attrs:{id:"谷歌一致性哈希"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#谷歌一致性哈希"}},[t._v("#")]),t._v(" 谷歌一致性哈希")]),t._v(" "),a("p",[t._v("jump consistent hash 是一种一致性哈希算法, 此算法零内存消耗，均匀分配，快速，并且只有 5 行代码。")]),t._v(" "),a("div",{staticClass:"language-C++ line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("int32_t JumpConsistentHash(uint64_t key, int32_t num_buckets) {\n    int64_t b = -1, j = 0;\n    while (j < num_buckets) {\n        b = j;\n        key = key * 2862933555777941757ULL + 1;\n        j = (b + 1) * (double(1LL << 31) / double((key >> 33) + 1));\n    }\n    return b;\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("h2",{attrs:{id:"代码实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代码实现"}},[t._v("#")]),t._v(" 代码实现")]),t._v(" "),a("p",[t._v("在 nodejs 中，使用"),a("code",[t._v("hashring.js")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-JavaScript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" HashRing "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hashring'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 传入节点权重，影响虚拟节点数量")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ring "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HashRing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'127.0.0.1:11211'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'127.0.0.2:11211'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" weight"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// same as above")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'127.0.0.3:11211'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3200")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'>>> 命中节点'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ring"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'your own ip'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("h2",{attrs:{id:"参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[t._v("#")]),t._v(" 参考链接")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("wiki: "),a("a",{attrs:{href:"https://zh.wikipedia.org/wiki/%E4%B8%80%E8%87%B4%E5%93%88%E5%B8%8C",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://zh.wikipedia.org/wiki/一致哈希"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[t._v("五分钟看懂一致性哈希算法："),a("a",{attrs:{href:"https://juejin.im/post/6844903598694858766",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://juejin.im/post/6844903598694858766"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/34985026",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://zhuanlan.zhihu.com/p/34985026"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[t._v("谷歌算法："),a("a",{attrs:{href:"http://arxiv.org/ftp/arxiv/papers/1406/1406.2294.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://arxiv.org/ftp/arxiv/papers/1406/1406.2294.pdf"),a("OutboundLink")],1)])])])])}),[],!1,null,null,null);s.default=e.exports}}]);