<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>心谭博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    <script type="text/javascript" src="/scripts/baidu-analytics.js" async=""></script>
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="专注前端与算法的博客">
    <link rel="preload" href="/assets/css/0.styles.ba668900.css" as="style"><link rel="preload" href="/assets/js/app.f478fbae.js" as="script"><link rel="preload" href="/assets/js/2.698e7189.js" as="script"><link rel="preload" href="/assets/js/3.9966209a.js" as="script"><link rel="preload" href="/assets/js/229.a56affd6.js" as="script"><link rel="preload" href="/assets/js/5.51d45416.js" as="script"><link rel="prefetch" href="/assets/js/10.125e849b.js"><link rel="prefetch" href="/assets/js/100.ecf0c9e0.js"><link rel="prefetch" href="/assets/js/101.488273e2.js"><link rel="prefetch" href="/assets/js/102.ce935938.js"><link rel="prefetch" href="/assets/js/103.0d50843d.js"><link rel="prefetch" href="/assets/js/104.dec558ea.js"><link rel="prefetch" href="/assets/js/105.aa96c243.js"><link rel="prefetch" href="/assets/js/106.e557f585.js"><link rel="prefetch" href="/assets/js/107.5418b2be.js"><link rel="prefetch" href="/assets/js/108.378422bb.js"><link rel="prefetch" href="/assets/js/109.f6bb72d2.js"><link rel="prefetch" href="/assets/js/11.1ccc6888.js"><link rel="prefetch" href="/assets/js/110.41d9adbd.js"><link rel="prefetch" href="/assets/js/111.29a1ddea.js"><link rel="prefetch" href="/assets/js/112.a7e5ec0e.js"><link rel="prefetch" href="/assets/js/113.4aecb2cb.js"><link rel="prefetch" href="/assets/js/114.47b56f5a.js"><link rel="prefetch" href="/assets/js/115.a38e6878.js"><link rel="prefetch" href="/assets/js/116.5e2808f5.js"><link rel="prefetch" href="/assets/js/117.de44b7f2.js"><link rel="prefetch" href="/assets/js/118.48fc4675.js"><link rel="prefetch" href="/assets/js/119.cac5adb8.js"><link rel="prefetch" href="/assets/js/12.2b8a914b.js"><link rel="prefetch" href="/assets/js/120.b5073751.js"><link rel="prefetch" href="/assets/js/121.76d9c9b9.js"><link rel="prefetch" href="/assets/js/122.bbdd442e.js"><link rel="prefetch" href="/assets/js/123.90edd15a.js"><link rel="prefetch" href="/assets/js/124.1a22938f.js"><link rel="prefetch" href="/assets/js/125.3a78e7c0.js"><link rel="prefetch" href="/assets/js/126.2170b737.js"><link rel="prefetch" href="/assets/js/127.a50d69a5.js"><link rel="prefetch" href="/assets/js/128.3aa5178c.js"><link rel="prefetch" href="/assets/js/129.52219775.js"><link rel="prefetch" href="/assets/js/13.146af216.js"><link rel="prefetch" href="/assets/js/130.a3fe595d.js"><link rel="prefetch" href="/assets/js/131.ffb980bb.js"><link rel="prefetch" href="/assets/js/132.30fd3f2b.js"><link rel="prefetch" href="/assets/js/133.3d494ec7.js"><link rel="prefetch" href="/assets/js/134.d5bef0ed.js"><link rel="prefetch" href="/assets/js/135.96e3dedb.js"><link rel="prefetch" href="/assets/js/136.c1ba8082.js"><link rel="prefetch" href="/assets/js/137.1d998785.js"><link rel="prefetch" href="/assets/js/138.eff08193.js"><link rel="prefetch" href="/assets/js/139.a74ff62d.js"><link rel="prefetch" href="/assets/js/14.d1605b0a.js"><link rel="prefetch" href="/assets/js/140.42d7cc5f.js"><link rel="prefetch" href="/assets/js/141.0be86f18.js"><link rel="prefetch" href="/assets/js/142.4cb518de.js"><link rel="prefetch" href="/assets/js/143.8e21f1f6.js"><link rel="prefetch" href="/assets/js/144.dcbe5600.js"><link rel="prefetch" href="/assets/js/145.33f3029c.js"><link rel="prefetch" href="/assets/js/146.37a87f52.js"><link rel="prefetch" href="/assets/js/147.3abbfff9.js"><link rel="prefetch" href="/assets/js/148.f73b5bb7.js"><link rel="prefetch" href="/assets/js/149.88bd82ad.js"><link rel="prefetch" href="/assets/js/15.ba36a578.js"><link rel="prefetch" href="/assets/js/150.7d145106.js"><link rel="prefetch" href="/assets/js/151.9d9f4771.js"><link rel="prefetch" href="/assets/js/152.9ce51fb1.js"><link rel="prefetch" href="/assets/js/153.29af3f5c.js"><link rel="prefetch" href="/assets/js/154.9e5e6f08.js"><link rel="prefetch" href="/assets/js/155.8e63a53b.js"><link rel="prefetch" href="/assets/js/156.d986d407.js"><link rel="prefetch" href="/assets/js/157.f56e37c7.js"><link rel="prefetch" href="/assets/js/158.1868b35b.js"><link rel="prefetch" href="/assets/js/159.9d6b377f.js"><link rel="prefetch" href="/assets/js/16.6c490e98.js"><link rel="prefetch" href="/assets/js/160.4079d370.js"><link rel="prefetch" href="/assets/js/161.3d1e0b85.js"><link rel="prefetch" href="/assets/js/162.e79b0472.js"><link rel="prefetch" href="/assets/js/163.ab16f20c.js"><link rel="prefetch" href="/assets/js/164.fae90350.js"><link rel="prefetch" href="/assets/js/165.1d7ad8e2.js"><link rel="prefetch" href="/assets/js/166.530126dd.js"><link rel="prefetch" href="/assets/js/167.3b072cf3.js"><link rel="prefetch" href="/assets/js/168.45fe3fa9.js"><link rel="prefetch" href="/assets/js/169.0b80f872.js"><link rel="prefetch" href="/assets/js/17.05eaa017.js"><link rel="prefetch" href="/assets/js/170.4f528b9c.js"><link rel="prefetch" href="/assets/js/171.a0aeeb5c.js"><link rel="prefetch" href="/assets/js/172.8f71a05d.js"><link rel="prefetch" href="/assets/js/173.e00e2e7b.js"><link rel="prefetch" href="/assets/js/174.52418ba2.js"><link rel="prefetch" href="/assets/js/175.030eb300.js"><link rel="prefetch" href="/assets/js/176.ca5b7419.js"><link rel="prefetch" href="/assets/js/177.c6d623d7.js"><link rel="prefetch" href="/assets/js/178.3f64d6fb.js"><link rel="prefetch" href="/assets/js/179.7dd709e7.js"><link rel="prefetch" href="/assets/js/18.1b658bb9.js"><link rel="prefetch" href="/assets/js/180.a5eb2128.js"><link rel="prefetch" href="/assets/js/181.de8b20cd.js"><link rel="prefetch" href="/assets/js/182.eaec82e3.js"><link rel="prefetch" href="/assets/js/183.27e2c119.js"><link rel="prefetch" href="/assets/js/184.d8edd40c.js"><link rel="prefetch" href="/assets/js/185.9f884e8c.js"><link rel="prefetch" href="/assets/js/186.aeb047bc.js"><link rel="prefetch" href="/assets/js/187.dd9473ed.js"><link rel="prefetch" href="/assets/js/188.ae03c25f.js"><link rel="prefetch" href="/assets/js/189.b1f6dbcd.js"><link rel="prefetch" href="/assets/js/19.26b9e4d9.js"><link rel="prefetch" href="/assets/js/190.7fc3b722.js"><link rel="prefetch" href="/assets/js/191.8c41b4b4.js"><link rel="prefetch" href="/assets/js/192.173942ef.js"><link rel="prefetch" href="/assets/js/193.0ebe20eb.js"><link rel="prefetch" href="/assets/js/194.ff6b30bb.js"><link rel="prefetch" href="/assets/js/195.2b97d7a8.js"><link rel="prefetch" href="/assets/js/196.fac53f1c.js"><link rel="prefetch" href="/assets/js/197.64a59f4d.js"><link rel="prefetch" href="/assets/js/198.95c9e0a6.js"><link rel="prefetch" href="/assets/js/199.6b83791e.js"><link rel="prefetch" href="/assets/js/20.388d03bf.js"><link rel="prefetch" href="/assets/js/200.3fbec35a.js"><link rel="prefetch" href="/assets/js/201.de42ae13.js"><link rel="prefetch" href="/assets/js/202.99efdd31.js"><link rel="prefetch" href="/assets/js/203.3ecda53b.js"><link rel="prefetch" href="/assets/js/204.6cdb0b3c.js"><link rel="prefetch" href="/assets/js/205.13ef96fa.js"><link rel="prefetch" href="/assets/js/206.782ead0f.js"><link rel="prefetch" href="/assets/js/207.d3984ab7.js"><link rel="prefetch" href="/assets/js/208.e86cc1ea.js"><link rel="prefetch" href="/assets/js/209.a05db817.js"><link rel="prefetch" href="/assets/js/21.ea7ddc97.js"><link rel="prefetch" href="/assets/js/210.4bfaffa7.js"><link rel="prefetch" href="/assets/js/211.7cb6e289.js"><link rel="prefetch" href="/assets/js/212.0c0ece64.js"><link rel="prefetch" href="/assets/js/213.3e74ea57.js"><link rel="prefetch" href="/assets/js/214.96abae91.js"><link rel="prefetch" href="/assets/js/215.8c9c781d.js"><link rel="prefetch" href="/assets/js/216.1242c16d.js"><link rel="prefetch" href="/assets/js/217.baf611b7.js"><link rel="prefetch" href="/assets/js/218.9207a585.js"><link rel="prefetch" href="/assets/js/219.f675ac7a.js"><link rel="prefetch" href="/assets/js/22.48c1844d.js"><link rel="prefetch" href="/assets/js/220.03861fcd.js"><link rel="prefetch" href="/assets/js/221.b5b098cd.js"><link rel="prefetch" href="/assets/js/222.039195d2.js"><link rel="prefetch" href="/assets/js/223.0dbda1f5.js"><link rel="prefetch" href="/assets/js/224.d3c6f57b.js"><link rel="prefetch" href="/assets/js/225.8dcf755e.js"><link rel="prefetch" href="/assets/js/226.86e7ed62.js"><link rel="prefetch" href="/assets/js/227.920ea7a7.js"><link rel="prefetch" href="/assets/js/228.b27cbe8d.js"><link rel="prefetch" href="/assets/js/23.af843b43.js"><link rel="prefetch" href="/assets/js/230.90ecc14e.js"><link rel="prefetch" href="/assets/js/231.a50ba866.js"><link rel="prefetch" href="/assets/js/232.6826940c.js"><link rel="prefetch" href="/assets/js/233.4b50e8a8.js"><link rel="prefetch" href="/assets/js/234.992ffb94.js"><link rel="prefetch" href="/assets/js/235.5560e5d3.js"><link rel="prefetch" href="/assets/js/236.282c7627.js"><link rel="prefetch" href="/assets/js/237.ee0eff29.js"><link rel="prefetch" href="/assets/js/238.06a7c830.js"><link rel="prefetch" href="/assets/js/239.2305a644.js"><link rel="prefetch" href="/assets/js/24.57d69605.js"><link rel="prefetch" href="/assets/js/240.8d7d509f.js"><link rel="prefetch" href="/assets/js/241.909f65af.js"><link rel="prefetch" href="/assets/js/242.1453db7a.js"><link rel="prefetch" href="/assets/js/243.358bb546.js"><link rel="prefetch" href="/assets/js/244.eabe3386.js"><link rel="prefetch" href="/assets/js/245.7b538c81.js"><link rel="prefetch" href="/assets/js/246.978d818b.js"><link rel="prefetch" href="/assets/js/247.1d473e2d.js"><link rel="prefetch" href="/assets/js/248.6022bb41.js"><link rel="prefetch" href="/assets/js/249.da8bc6d4.js"><link rel="prefetch" href="/assets/js/25.4e035733.js"><link rel="prefetch" href="/assets/js/250.ad443c34.js"><link rel="prefetch" href="/assets/js/251.8ec7073c.js"><link rel="prefetch" href="/assets/js/252.b8e54476.js"><link rel="prefetch" href="/assets/js/253.e88d077f.js"><link rel="prefetch" href="/assets/js/254.433a6654.js"><link rel="prefetch" href="/assets/js/255.d46248e3.js"><link rel="prefetch" href="/assets/js/256.8ca68cc4.js"><link rel="prefetch" href="/assets/js/257.e53e1425.js"><link rel="prefetch" href="/assets/js/258.5f90d970.js"><link rel="prefetch" href="/assets/js/259.3409f224.js"><link rel="prefetch" href="/assets/js/26.64a7917e.js"><link rel="prefetch" href="/assets/js/260.26197d67.js"><link rel="prefetch" href="/assets/js/261.ee93c99d.js"><link rel="prefetch" href="/assets/js/262.ec3f123e.js"><link rel="prefetch" href="/assets/js/263.4a108917.js"><link rel="prefetch" href="/assets/js/264.2450407d.js"><link rel="prefetch" href="/assets/js/265.f81c98d1.js"><link rel="prefetch" href="/assets/js/266.963dbdcb.js"><link rel="prefetch" href="/assets/js/267.45c41b8b.js"><link rel="prefetch" href="/assets/js/268.10042086.js"><link rel="prefetch" href="/assets/js/269.7b986c0f.js"><link rel="prefetch" href="/assets/js/27.c2ce77e5.js"><link rel="prefetch" href="/assets/js/270.2c7179a3.js"><link rel="prefetch" href="/assets/js/271.2a53953e.js"><link rel="prefetch" href="/assets/js/272.7f683fa7.js"><link rel="prefetch" href="/assets/js/273.97e1ffb1.js"><link rel="prefetch" href="/assets/js/274.15e56697.js"><link rel="prefetch" href="/assets/js/275.209a5337.js"><link rel="prefetch" href="/assets/js/276.15b36e13.js"><link rel="prefetch" href="/assets/js/277.30ef5862.js"><link rel="prefetch" href="/assets/js/278.944db84b.js"><link rel="prefetch" href="/assets/js/279.699674ae.js"><link rel="prefetch" href="/assets/js/28.013d42b0.js"><link rel="prefetch" href="/assets/js/280.986361cd.js"><link rel="prefetch" href="/assets/js/281.cfc3e14b.js"><link rel="prefetch" href="/assets/js/282.4d9c900f.js"><link rel="prefetch" href="/assets/js/283.830bab2e.js"><link rel="prefetch" href="/assets/js/284.1649ea94.js"><link rel="prefetch" href="/assets/js/285.8efbaa54.js"><link rel="prefetch" href="/assets/js/286.b95281f9.js"><link rel="prefetch" href="/assets/js/287.1434dc4e.js"><link rel="prefetch" href="/assets/js/288.9616ea68.js"><link rel="prefetch" href="/assets/js/289.e64f985c.js"><link rel="prefetch" href="/assets/js/29.ada84a99.js"><link rel="prefetch" href="/assets/js/290.f39fd36b.js"><link rel="prefetch" href="/assets/js/291.05d0a77c.js"><link rel="prefetch" href="/assets/js/292.2cefca4f.js"><link rel="prefetch" href="/assets/js/293.135a6682.js"><link rel="prefetch" href="/assets/js/294.d57140d2.js"><link rel="prefetch" href="/assets/js/295.f2970689.js"><link rel="prefetch" href="/assets/js/296.21acd6c4.js"><link rel="prefetch" href="/assets/js/297.71d9f7f7.js"><link rel="prefetch" href="/assets/js/298.eb488ca4.js"><link rel="prefetch" href="/assets/js/299.c91c64c9.js"><link rel="prefetch" href="/assets/js/30.d76a421c.js"><link rel="prefetch" href="/assets/js/300.e404f168.js"><link rel="prefetch" href="/assets/js/301.11a56117.js"><link rel="prefetch" href="/assets/js/302.a27fc58a.js"><link rel="prefetch" href="/assets/js/303.0ef3ae33.js"><link rel="prefetch" href="/assets/js/304.397a6915.js"><link rel="prefetch" href="/assets/js/305.8e37f27c.js"><link rel="prefetch" href="/assets/js/306.92cc7922.js"><link rel="prefetch" href="/assets/js/307.87ab2242.js"><link rel="prefetch" href="/assets/js/308.f4717d56.js"><link rel="prefetch" href="/assets/js/309.334750a4.js"><link rel="prefetch" href="/assets/js/31.16080819.js"><link rel="prefetch" href="/assets/js/310.abe10266.js"><link rel="prefetch" href="/assets/js/311.4f8695ae.js"><link rel="prefetch" href="/assets/js/312.52a3160d.js"><link rel="prefetch" href="/assets/js/313.344aff07.js"><link rel="prefetch" href="/assets/js/314.0bf4c0bb.js"><link rel="prefetch" href="/assets/js/315.4da73cad.js"><link rel="prefetch" href="/assets/js/316.2796c673.js"><link rel="prefetch" href="/assets/js/317.87e3844c.js"><link rel="prefetch" href="/assets/js/318.e7701d79.js"><link rel="prefetch" href="/assets/js/319.a3d489d6.js"><link rel="prefetch" href="/assets/js/32.1bfb0d2f.js"><link rel="prefetch" href="/assets/js/320.dc5b5d91.js"><link rel="prefetch" href="/assets/js/321.705a66ad.js"><link rel="prefetch" href="/assets/js/322.311ad61f.js"><link rel="prefetch" href="/assets/js/323.29ad7f94.js"><link rel="prefetch" href="/assets/js/324.11e9657a.js"><link rel="prefetch" href="/assets/js/325.c292ec13.js"><link rel="prefetch" href="/assets/js/326.2fadd0c5.js"><link rel="prefetch" href="/assets/js/327.ae5c22e5.js"><link rel="prefetch" href="/assets/js/328.c7f9b408.js"><link rel="prefetch" href="/assets/js/329.63c33840.js"><link rel="prefetch" href="/assets/js/33.9e4ec2aa.js"><link rel="prefetch" href="/assets/js/330.b9a9128f.js"><link rel="prefetch" href="/assets/js/331.178f0f0b.js"><link rel="prefetch" href="/assets/js/332.91dbe7d8.js"><link rel="prefetch" href="/assets/js/333.5c920372.js"><link rel="prefetch" href="/assets/js/334.d8f3bbe2.js"><link rel="prefetch" href="/assets/js/335.44d1d5a4.js"><link rel="prefetch" href="/assets/js/336.eb3286ce.js"><link rel="prefetch" href="/assets/js/337.50f44085.js"><link rel="prefetch" href="/assets/js/338.d98a7547.js"><link rel="prefetch" href="/assets/js/339.1da6f36f.js"><link rel="prefetch" href="/assets/js/34.a0daddcb.js"><link rel="prefetch" href="/assets/js/340.e729428d.js"><link rel="prefetch" href="/assets/js/341.201e2338.js"><link rel="prefetch" href="/assets/js/342.5d6fd80d.js"><link rel="prefetch" href="/assets/js/343.bf6c1a53.js"><link rel="prefetch" href="/assets/js/35.1eb4e4a0.js"><link rel="prefetch" href="/assets/js/36.f668800d.js"><link rel="prefetch" href="/assets/js/37.dbf95fc8.js"><link rel="prefetch" href="/assets/js/38.211b6e60.js"><link rel="prefetch" href="/assets/js/39.10a3442a.js"><link rel="prefetch" href="/assets/js/4.924b2ca5.js"><link rel="prefetch" href="/assets/js/40.7796b507.js"><link rel="prefetch" href="/assets/js/41.d6bd0371.js"><link rel="prefetch" href="/assets/js/42.1b393698.js"><link rel="prefetch" href="/assets/js/43.d3b71cba.js"><link rel="prefetch" href="/assets/js/44.87edd570.js"><link rel="prefetch" href="/assets/js/45.28eab6a9.js"><link rel="prefetch" href="/assets/js/46.d9f259db.js"><link rel="prefetch" href="/assets/js/47.c7525769.js"><link rel="prefetch" href="/assets/js/48.a368c70a.js"><link rel="prefetch" href="/assets/js/49.7ec12d35.js"><link rel="prefetch" href="/assets/js/50.721adef2.js"><link rel="prefetch" href="/assets/js/51.d81fa0a5.js"><link rel="prefetch" href="/assets/js/52.a12c1929.js"><link rel="prefetch" href="/assets/js/53.91181033.js"><link rel="prefetch" href="/assets/js/54.8cd29143.js"><link rel="prefetch" href="/assets/js/55.786d0609.js"><link rel="prefetch" href="/assets/js/56.f16818c1.js"><link rel="prefetch" href="/assets/js/57.ec6f9977.js"><link rel="prefetch" href="/assets/js/58.05d3bfe4.js"><link rel="prefetch" href="/assets/js/59.514e5c51.js"><link rel="prefetch" href="/assets/js/6.e699cefb.js"><link rel="prefetch" href="/assets/js/60.cd4340b7.js"><link rel="prefetch" href="/assets/js/61.92ff87b0.js"><link rel="prefetch" href="/assets/js/62.66ba8fcc.js"><link rel="prefetch" href="/assets/js/63.7e4002c5.js"><link rel="prefetch" href="/assets/js/64.e52f39b1.js"><link rel="prefetch" href="/assets/js/65.7d29999d.js"><link rel="prefetch" href="/assets/js/66.144eca10.js"><link rel="prefetch" href="/assets/js/67.523d8fc4.js"><link rel="prefetch" href="/assets/js/68.e3888dbb.js"><link rel="prefetch" href="/assets/js/69.9bb4d391.js"><link rel="prefetch" href="/assets/js/7.465d1635.js"><link rel="prefetch" href="/assets/js/70.363f057d.js"><link rel="prefetch" href="/assets/js/71.b458f4e3.js"><link rel="prefetch" href="/assets/js/72.61151392.js"><link rel="prefetch" href="/assets/js/73.cf6a509e.js"><link rel="prefetch" href="/assets/js/74.bcf79daa.js"><link rel="prefetch" href="/assets/js/75.6c76dbd9.js"><link rel="prefetch" href="/assets/js/76.8fa20a2d.js"><link rel="prefetch" href="/assets/js/77.1b38be38.js"><link rel="prefetch" href="/assets/js/78.912ab295.js"><link rel="prefetch" href="/assets/js/79.e7dced28.js"><link rel="prefetch" href="/assets/js/8.e18242d7.js"><link rel="prefetch" href="/assets/js/80.a0dff15f.js"><link rel="prefetch" href="/assets/js/81.db56dec0.js"><link rel="prefetch" href="/assets/js/82.8ce4450e.js"><link rel="prefetch" href="/assets/js/83.fc4d85db.js"><link rel="prefetch" href="/assets/js/84.7cb34b0d.js"><link rel="prefetch" href="/assets/js/85.7291027d.js"><link rel="prefetch" href="/assets/js/86.7f8f9892.js"><link rel="prefetch" href="/assets/js/87.03d1d1d8.js"><link rel="prefetch" href="/assets/js/88.ac4d9da3.js"><link rel="prefetch" href="/assets/js/89.11401d6e.js"><link rel="prefetch" href="/assets/js/9.44357992.js"><link rel="prefetch" href="/assets/js/90.febbf57e.js"><link rel="prefetch" href="/assets/js/91.ffedb304.js"><link rel="prefetch" href="/assets/js/92.20b8342a.js"><link rel="prefetch" href="/assets/js/93.77977da0.js"><link rel="prefetch" href="/assets/js/94.ef9094a7.js"><link rel="prefetch" href="/assets/js/95.0136b399.js"><link rel="prefetch" href="/assets/js/96.6bef417b.js"><link rel="prefetch" href="/assets/js/97.30ebc59a.js"><link rel="prefetch" href="/assets/js/98.0a5e3de0.js"><link rel="prefetch" href="/assets/js/99.24f40c7d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ba668900.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">心谭博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">
  技能图谱
</a></div><div class="nav-item"><a href="https://xxoo521.com/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端图谱
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/algorithm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法题解
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dongyuanxin/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">
  技能图谱
</a></div><div class="nav-item"><a href="https://xxoo521.com/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端图谱
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/algorithm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法题解
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dongyuanxin/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构和算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notes/02.设计模式/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>架构设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程语言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notes/08.云开发/" class="sidebar-heading clickable"><span>云开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node高性能服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web前端开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>区块链</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/notes/12.容器化/" class="sidebar-heading clickable"><span>容器化</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/notes/13.ELK/" class="sidebar-link">ELK</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>这是阅读《MongoDB 实战》所做的，关于基础、编码和优化方面的读书笔记。</p></blockquote> <h2 id="mongodb-特性和介绍"><a href="#mongodb-特性和介绍" class="header-anchor">#</a> MongoDB 特性和介绍</h2> <h3 id="_1-简介"><a href="#_1-简介" class="header-anchor">#</a> 1. 简介</h3> <p>MongoDB 的特点：扩展策略、直观的数据模型。在 mongodb 中，编程语言定义的对象能被“原封不变”地持久化，消除对象结构和程序映射的复杂性。</p> <h3 id="_2-主要特性"><a href="#_2-主要特性" class="header-anchor">#</a> 2. 主要特性</h3> <h4 id="数据模型"><a href="#数据模型" class="header-anchor">#</a> 数据模型</h4> <p>关系型与正规化：对于关系型数据库，数据表本质上是<strong>扁平的</strong>，因此表示多个一对多关系就需要多张表。经常用到的技术是<strong>拆表</strong>，这种技术是<strong>正规化</strong>。</p> <p>但对于 Mongo 来说，文档支持嵌套等多种格式，无需事先定义<strong>Schema</strong>。</p> <h4 id="即时查询"><a href="#即时查询" class="header-anchor">#</a> 即时查询</h4> <p>mysql 和 mongodb 都支持<strong>即时查询</strong>，不同的是：前者依赖正则化的模型；后者假定查询字段是存储与文档中的。</p> <h4 id="二级索引"><a href="#二级索引" class="header-anchor">#</a> 二级索引</h4> <p>mongodb 支持二级索引，是通过 b-tree 实现的。</p> <h4 id="复制"><a href="#复制" class="header-anchor">#</a> 复制</h4> <p>通过<strong>副本集</strong>的拓扑结构来提供复制功能，其目的是：<strong>提供数据的冗余</strong>。</p> <p>副本集的主节点能接受读写操作，但从节点是只读的。主节点出问题，会自动故障转移，选取一个从节点升级为主节点。</p> <h4 id="写速度和持久性"><a href="#写速度和持久性" class="header-anchor">#</a> 写速度和持久性</h4> <p>写速度：给定时间内，数据库可以处理的插入、更新和删除操作的数量。</p> <p>持久性：数据库保持上述写操作的结果不改变的，所用的时间长短。</p> <p>DB 领域，<strong>写速度和持久性存在一种相反关系</strong>。很好理解，例如 memcached，直接写入内存，写速度非常快，但同时数据完全易失。</p> <p>mongodb 的写操作，默认是<strong>fire-and-forget</strong>：通过 TCP 发送写操作，不要求数据库应答。用户可以开启<strong>安全模式</strong>，保证写操作正确无误写入 db。并且安全模式可以配置，用于<strong>阻塞操作</strong>。</p> <p>对于高容量、低价值数据（点击流、日志），默认模式更优；对于重要数据，倾向于安全模式。</p> <p>mongo 中，<strong>Journaling 日志</strong>默认开启。所有写操作会被提交到一个只能追加的日志中。以应对故障后的，重启修复服务。</p> <h4 id="数据库扩展"><a href="#数据库扩展" class="header-anchor">#</a> 数据库扩展</h4> <ul><li>垂直扩展（向上扩展）：升级硬件，来提高单点性能</li> <li>水平扩展（向外扩展）：将数据库分布到多台机器，是基于<strong>自动分片</strong>。其中，单独的分片由一个副本集组成，至少有 2 个节点，保证没有单点失败。</li></ul> <h3 id="_3-核心服务器和工具"><a href="#_3-核心服务器和工具" class="header-anchor">#</a> 3. 核心服务器和工具</h3> <h4 id="核心服务器"><a href="#核心服务器" class="header-anchor">#</a> 核心服务器</h4> <p>通过<code>mongod</code>可以运行核心服务器。数据文件存储在<code>/data/db</code>中。如果下载编译 mongo 的源代码，需要手动创建<code>/data/db</code>，并且为其分配权限。</p> <p>其中，mongo 的<strong>内存管理</strong>是由操作系统来处理的。数据文件通过<code>mmap()</code>系统 API，映射成系统的虚拟内存。</p> <h4 id="命令行"><a href="#命令行" class="header-anchor">#</a> 命令行</h4> <p>是基于 JavaScript 编写的。所以能看到很多通用的语法，以及输出的格式。</p> <h4 id="数据库驱动"><a href="#数据库驱动" class="header-anchor">#</a> 数据库驱动</h4> <p>针对多个语言，都提供了<strong>驱动</strong>使用。并且风格几乎保持统一的 API 接口。</p> <h4 id="命令行工具"><a href="#命令行工具" class="header-anchor">#</a> 命令行工具</h4> <p>安装到 MaxOS 后，全局会多出以下命令：</p> <ul><li><code>mongodump</code>和<code>mongorestore</code>：前者用<code>BSON</code>格式，来备份数据库数据。方便后者恢复。</li> <li><code>mongoexport</code>和<code>mongoimport</code>：导入导出 JSON、CSV 和 TSV 格式数据。</li></ul> <h3 id="_4-mongo-的场景"><a href="#_4-mongo-的场景" class="header-anchor">#</a> 4. Mongo 的场景</h3> <p>适用于<strong>事先无法知晓数据结构</strong>的数据，或者<strong>数据结构经常不确定性较大</strong>的数据。</p> <p>除此之外，还适用于<strong>与分析相关的场景</strong>。mongo 提供一种<strong>固定集合</strong>，常用于日志，特点是<strong>分配的大小固定</strong>，类似于循环队列。</p> <h3 id="_5-局限"><a href="#_5-局限" class="header-anchor">#</a> 5. 局限</h3> <p>由于使用内存映射，32 位系统只能对 4GB 内存寻址。一半内存被 os 占用，那么只有 2GB 能用来做映射文件。所以，<strong>必须部署在 64 位操作系统上</strong>。</p> <h2 id="程序编写基础"><a href="#程序编写基础" class="header-anchor">#</a> 程序编写基础</h2> <p>mongo 驱动的 find 方法，返回的是<strong>游标对象</strong>，可以理解为迭代器的下标。在 NodeJS 中，它的名字和类型是<code>Cursor</code>。</p> <p>在 Nodejs 中，</p> <h3 id="_1-驱动工作原理"><a href="#_1-驱动工作原理" class="header-anchor">#</a> 1. 驱动工作原理</h3> <p>主要有 3 个功能：</p> <ol><li>生成 MongoDB 对象的 ID，它是存储在<code>_id</code>字段中的默认值</li> <li>驱动会把特定语言的文档表述，和<code>BSON</code>互换</li> <li>使用 TCP 套接字与数据库通信</li></ol> <h4 id="对象-id"><a href="#对象-id" class="header-anchor">#</a> 对象 ID</h4> <p>在自带的交互式命令行中:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> id <span class="token operator">=</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5d9413867cc8dacf9247fe3e&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于生成的<code>5d9413867cc8dacf9247fe3e</code>:</p> <div class="language- extra-class"><pre><code>- 5d941386 ，这4个字节是时间戳，单位秒数
- 7cc8da，机器ID
- cf92，进程ID
- 47fe3e，计数器
</code></pre></div><h3 id="_2-安全写入模式-write-concern"><a href="#_2-安全写入模式-write-concern" class="header-anchor">#</a> 2. 安全写入模式(Write Concern)</h3> <p>对所有的写操作（插入、更新或删除）都能开启此模式。以此保证，操作一定在数据库层面生效。</p> <p>在 v4.0 中，以 insert 为例，文档如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>db<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>
   <span class="token operator">&lt;</span>document or array <span class="token keyword">of</span> documents<span class="token operator">&gt;</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span>
     writeConcern<span class="token operator">:</span> <span class="token operator">&lt;</span>document<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     ordered<span class="token operator">:</span> <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>关于 Write Concern 的详细参数，可以看这篇文档：https://docs.mongodb.com/manual/reference/write-concern/</p> <p>其中，重要的是<code>w</code> 参数，它可以指定是否使用应答写入。目前默认是 1，应答式写入。设置为 0，则是非应答式。</p> <h2 id="面向文档的数据"><a href="#面向文档的数据" class="header-anchor">#</a> 面向文档的数据</h2> <h3 id="_1-schema-设计原则"><a href="#_1-schema-设计原则" class="header-anchor">#</a> 1. Schema 设计原则</h3> <p>设计数据库 Schema 式根据数据库特点和应用程序需求的情况下，为数据集选择最佳表述的过程。</p> <h3 id="_2-设计电子商务数据模型"><a href="#_2-设计电子商务数据模型" class="header-anchor">#</a> 2. 设计电子商务数据模型</h3> <h4 id="一对多：产品和分类"><a href="#一对多：产品和分类" class="header-anchor">#</a> 一对多：产品和分类</h4> <p>假设一个电商场景，要对一个商品 doc 进行设计。对于商品，它有多个分类 category，因此需要<strong>一对多操作</strong>，同时，mongo 不支持联结操作（join）。</p> <p>因此解决方案是，在商品的一个字段中，保存<strong>分类指针</strong>的数组。这里的指针，就是 mongo 中的对象 ID。</p> <p>下面是一个简单的例子：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt; db.products.find()
{ &quot;_id&quot; : ObjectId(&quot;5d9423257cc8dacf9247fe41&quot;), &quot;categories&quot; : [ ObjectId(&quot;5d9423017cc8dacf9247fe3f&quot;) ] }
&gt; db.categories.find({})
{ &quot;_id&quot; : ObjectId(&quot;5d9423017cc8dacf9247fe3f&quot;), &quot;name&quot; : &quot;分类1&quot; }
{ &quot;_id&quot; : ObjectId(&quot;5d9423037cc8dacf9247fe40&quot;), &quot;name&quot; : &quot;分类2&quot; }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="一对多：用户与订单"><a href="#一对多：用户与订单" class="header-anchor">#</a> 一对多：用户与订单</h4> <p>和前面的关系不同，这里的“多”体现在“订单”上。这里的订单中，保存着指向用户的指针。</p> <h4 id="评论"><a href="#评论" class="header-anchor">#</a> 评论</h4> <p>每个产品会有多个评论，而每个评论，可能会有点赞人列表。当要展示返回给前端的时候，需要获取产品评论，并且获取点赞人列表。</p> <p>方案 1：点赞人列表，保存着由指针组成的集合。可以先查询产品评论后，再对点赞做 2 次查询。</p> <p>方案 2：由于仅需要点赞人的头像和名称（少量信息），可以使用<strong>去正规化</strong>，不再保存指针，而是简单信息。</p> <p>上面 2 种方案，都可以防止重复点赞的发生。</p> <h3 id="_3-具体细节"><a href="#_3-具体细节" class="header-anchor">#</a> 3. 具体细节</h3> <h4 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h4> <p>即使使用<code>use</code>切换一个新的数据库，如果没有 insert 数据，该数据库并不会创建。</p> <p>mongodb 会为数据、集合、索引进行空间分配，并且采取的是<strong>预分配</strong>的方式，每次空间不够的时候，扩充 2 倍。</p> <p>通过 <code>db.stats()</code> 可以查看当前 db 的状态，下面是一个示例：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> db<span class="token punctuation">.</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;db&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;info_keeper&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;collections&quot;</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
	<span class="token string">&quot;views&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string">&quot;objects&quot;</span> <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
	<span class="token string">&quot;avgObjSize&quot;</span> <span class="token operator">:</span> <span class="token number">255.8181818181818</span><span class="token punctuation">,</span>
	<span class="token string">&quot;dataSize&quot;</span> <span class="token operator">:</span> <span class="token number">2814</span><span class="token punctuation">,</span> <span class="token comment">// 数据库中BSON对象实际大小</span>
	<span class="token string">&quot;storageSize&quot;</span> <span class="token operator">:</span> <span class="token number">86016</span><span class="token punctuation">,</span> <span class="token comment">// 包含了集合增长的预留空间和未分配的已删除空间</span>
	<span class="token string">&quot;numExtents&quot;</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token string">&quot;indexes&quot;</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
	<span class="token string">&quot;indexSize&quot;</span> <span class="token operator">:</span> <span class="token number">155648</span><span class="token punctuation">,</span> <span class="token comment">// 数据库索引大小的空间</span>
	<span class="token string">&quot;fsUsedSize&quot;</span> <span class="token operator">:</span> <span class="token number">86272356352</span><span class="token punctuation">,</span>
	<span class="token string">&quot;fsTotalSize&quot;</span> <span class="token operator">:</span> <span class="token number">250685575168</span><span class="token punctuation">,</span>
	<span class="token string">&quot;ok&quot;</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="集合"><a href="#集合" class="header-anchor">#</a> 集合</h4> <p>1、重命名操作：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> use test
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>orders<span class="token punctuation">.</span><span class="token function">renameCollection</span><span class="token punctuation">(</span> <span class="token string">&quot;orders2014&quot;</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2、固定集合</p> <p>对应日志统计之类的、<strong>只有最近的数据才有价值</strong>的场景下，可以使用<strong>固定集合</strong>：一旦容量到上限，后续插入会逐步覆盖最先插入的文档。</p> <p>创建时候，需要同时指定<code>createCollection</code>的 capped 和 size 参数：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>db.createCollection('logs',{ capped : true, size : 5242880 })
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>为了性能优化，mongo<strong>不会为固定集合创建针对<code>_id</code>的索引</strong>。同时，不能从中删除 doc，也不能执行任何更改文档大小的更新操作。</p> <p>3、键名选择</p> <p><strong>慎重选择键名</strong>，例如，用<code>dob</code>代替<code>date_of_birth</code>，一个文档可以省下 10 字节。</p> <h2 id="查询和聚合"><a href="#查询和聚合" class="header-anchor">#</a> 查询和聚合</h2> <h3 id="_1-查询常见技巧"><a href="#_1-查询常见技巧" class="header-anchor">#</a> 1. 查询常见技巧</h3> <p><strong>分页查询</strong>可以通过<code>skip</code>和<code>limit</code>配合使用实现。</p> <p><strong>空值查询</strong>可以通过驱动的空值字面量实现，比如在 node 中，想查询<code>logs</code>中不包含<code>name</code>字段的记录：<code>db.logs.find({ name: null })</code>。</p> <p><strong>减少序列化和网络传输</strong>，可以通过给定 find 的第二个参数，来选定数据库返回给驱动的文档的字段，比如：<code>db.products.find({}, {_id: 1})</code>。这条命令，只返回文档的<code>_id</code>字段。</p> <p><strong>复合索引</strong>，复合索引的设定，遵循着「从准确到宽泛」的规则。比如对于订单记录，有着下单人和时间 2 个字段。应该先为下单人字段设置索引，再为时间字段设置索引。可以理解为前者是精确查找，可以大大缩小查找结果集；后者是范围查找。</p> <p><strong>嵌套字段查询</strong>，对于负责对象字段的查询，直接通过<code>.</code>运算符即可。例如：<code>db.demos.find({a: {b : 1}})</code>和<code>db.demos.find({&quot;a.b&quot;: 1})</code> 是等效的。</p> <h3 id="_2-常见查询语言"><a href="#_2-常见查询语言" class="header-anchor">#</a> 2. 常见查询语言</h3> <p>MongoDB 的查询本质：实例化了一个游标，并获取它的结果集。</p> <h4 id="范围查询"><a href="#范围查询" class="header-anchor">#</a> 范围查询</h4> <p>范围操作符用法很简单，但注意：不要在范围查找时候误用<strong>重复搜索键</strong>。</p> <p>错误：<code>db.users.find({age: { $gte: 0 }, age: { $lte: 30 } })</code></p> <p>正确：<code>db.users.find({age: {$gte: 0, $lte: 30}})</code></p> <h4 id="集合操作"><a href="#集合操作" class="header-anchor">#</a> 集合操作</h4> <p>集合操作符一共有 3 个：<code>$in</code>、<code>$all</code>、<code>$nin</code>。</p> <p>in 和 nin 是一对，in 相当于使用多个 OR 操作符：<code>db.products.find({'tags': {$in: [ObjectId('...'), ObjectId('...')]}})</code></p> <p>all 的作用属性，必须是数组形式：<code>db.products.find({tags: {$all: ['a', 'b']}})</code></p> <p>⚠️ 注意：in 和 all 可以利用索引；nin 不能利用索引，只能使用<strong>集合扫描</strong>。这和 BTree 结构有关。</p> <h4 id="布尔操作"><a href="#布尔操作" class="header-anchor">#</a> 布尔操作</h4> <p>常见的有：<code>$ne</code>、<code>$not</code>、 <code>$or</code>、 <code>$and</code>、<code>$exists</code>。同样的，<code>$ne</code>不能利用索引。</p> <p>对于 not 的使用，如果使用的操作符或者正则表达式不存在否定形式，才配合 not。例如大于，就有小于等于操作符。</p> <p>对与 or 的使用，or 可以<strong>表示不同键的值的关系</strong>，而 in 只能表示一个键的值的关系。例如：<code>db.products.find({ $or: [{ name: 'a' }, { name: 'b' }] })</code></p> <h4 id="子文档"><a href="#子文档" class="header-anchor">#</a> 子文档</h4> <p>对于内嵌对象匹配，用<code>.</code>运算符即可，正如前面的嵌套字段查询所述。</p> <p><strong>不推荐</strong>对于整个对象的查询，需要严格保证查询字段的顺序。</p> <h4 id="数组"><a href="#数组" class="header-anchor">#</a> 数组</h4> <p>如果数组中元素是基础对象，那么直接查询即可。mongo 识别字段是数组类型，会自动查询字段是否位于其中。</p> <p>例如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>tags: <span class="token punctuation">[</span><span class="token string">'a'</span>, <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
WriteResult<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;nInserted&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span>tags: <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948025da0946c664997712&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;tags&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;b&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果数组中元素是负责对象，可以借助<code>.</code>运算符进行访问：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.insert<span class="token punctuation">(</span><span class="token punctuation">{</span>address: <span class="token punctuation">[</span><span class="token punctuation">{</span>name: <span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
WriteResult<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;nInserted&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;address.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948055da0946c664997713&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;home&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>同样地，你也可以指定针对特定顺序的数组元素：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;address.0.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">'home'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948055da0946c664997713&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;home&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果要同时将<strong>多个条件限制在同一个子文档</strong>上，下面是错误和正确的做法 👇</p> <p>错误：<code>db.products.find({&quot;address.name&quot;: 'home', 'address.state': 'NY'})</code></p> <p>正确：<code>db.products.find({address: {$elemMatch: {name: 'home', state: 'NY'} }})</code></p> <h4 id="javascript-查询"><a href="#javascript-查询" class="header-anchor">#</a> Javascript 查询</h4> <p>对于一些复杂查询，借助<code>$where</code>可以使用 js 表达式。还是以刚才的数据为例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.products.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token variable">$where</span><span class="token builtin class-name">:</span> <span class="token string">&quot;function() {return this.address &amp;&amp; this.address.length}&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d948055da0946c664997713&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;address&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;home&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在使用的时候，需要启动 js 解释器和上下文，因此<strong>开销大</strong>。在使用的时候，尽量带上其他标准查询操作，来缩小查询范围。</p> <p>除此之外，还有注入攻击的可能。主要体现在驱动使用时候，如果后端传给 db 的字段是没做检验的，可能发生注入攻击。</p> <h4 id="正则表达式"><a href="#正则表达式" class="header-anchor">#</a> 正则表达式</h4> <p>主要体现在驱动使用上。</p> <p>如果支持 js 的正则，那么可以: <code>find({text: /best/i})</code></p> <p>如果不支持，那么：<code>find({text: {$regex: 'best', $options: 'i'}})</code></p> <h4 id="类型"><a href="#类型" class="header-anchor">#</a> 类型</h4> <p>通过<code>$type</code>，可以根据指定字段类型进行查询。不同的值，代表不同的类型。请见官方文档。</p> <h3 id="_3-查询选项"><a href="#_3-查询选项" class="header-anchor">#</a> 3. 查询选项</h3> <h4 id="投影"><a href="#投影" class="header-anchor">#</a> 投影</h4> <p>1、使用选择字段进行返回，降低网络传输：<code>find</code>给定第二个参数。</p> <p>2、返回保存在结果数组中的某个范围的值：<code>$slice([start, limit])</code>。例如：<code>db.products.find({}, { comments: {$slice: 12}})</code></p> <h4 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h4> <p>能够对<strong>多个字段</strong>进行升序/降序排列。例如：<code>db.comments.find().sort({rating: -1, votes: -1})</code></p> <h4 id="skip-和-limit"><a href="#skip-和-limit" class="header-anchor">#</a> skip 和 limit</h4> <p>如果向 skip 传入很大的值，需要扫描同等数量的文档，浪费资源。</p> <p>最好的方法是：通过查询条件，缩小要扫描的文档。</p> <h3 id="_4-聚合指令"><a href="#_4-聚合指令" class="header-anchor">#</a> 4. 聚合指令</h3> <p>在 v2 的版本中，mongo 只能通过 map、reduce 等基础操作来支持聚合搜索。但在 v3 的版本后，mongo 本身提供了丰富的聚合阶段(<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline" target="_blank" rel="noopener noreferrer">aggregation pipeline<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)和聚合运算符(<a href="https://docs.mongodb.com/manual/reference/operator/aggregation/" target="_blank" rel="noopener noreferrer">aggregation operator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p> <p>以<code>$group</code>和<code>$sum</code>为例，插入了 a 和 b 两种售卖货物以及价钱：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.sales.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d98ca8094ffea590a8a85c6&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;coin&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">100</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d98ca8694ffea590a8a85c7&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;coin&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">200</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5d98ca9094ffea590a8a85c8&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;b&quot;</span>, <span class="token string">&quot;coin&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">800</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>利用聚合操作，就可以便捷算出每种货物的总价：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">&gt;</span> db.sales.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> _id: <span class="token string">&quot;<span class="token variable">$name</span>&quot;</span>, total: <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$coin</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;b&quot;</span>, <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">800</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;a&quot;</span>, <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">300</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最后说一下，聚合的意义在于数据库提供给使用者此种功能以及相关优化。当然，使用者完全可以在逻辑层面查询到需要的集合，代码中进行计算。但对于服务的提供商，完整的服务是必不可少的。</p> <h2 id="更新、原子操作与删除"><a href="#更新、原子操作与删除" class="header-anchor">#</a> 更新、原子操作与删除</h2> <h3 id="_1-文档更新入门"><a href="#_1-文档更新入门" class="header-anchor">#</a> 1. 文档更新入门</h3> <p>文档更新分为：替换更新和针对性更新。相较而言，<strong>针对性更新</strong>具有性能好、传输数据少和允许原子性更新的优点。</p> <p>利用<code>$set</code>和<code>$push</code>可以针对文档和其中的数组字段进行针对性更新，下面是针对性更新的例子：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>db.products.update<span class="token punctuation">(</span>
   <span class="token punctuation">{</span> _id: <span class="token number">100</span> <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span> <span class="token variable">$set</span><span class="token builtin class-name">:</span>
      <span class="token punctuation">{</span>
        quantity: <span class="token number">500</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果是替换更新，遇到增加计数器值之类的场景，在不使用乐观锁的情况下，无法保证原子性更新。因为需要先读出数据，然后再更新。此过程中，可能会有其他并发程序重写字段，从而造成脏数据。</p> <p>以更新计数器的针对性更新为例：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>db.products.update<span class="token punctuation">(</span>
   <span class="token punctuation">{</span> sku: <span class="token string">&quot;abc123&quot;</span> <span class="token punctuation">}</span>,
   <span class="token punctuation">{</span> <span class="token variable">$inc</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> quantity: -1 <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-电子商务数据模型中的更新"><a href="#_2-电子商务数据模型中的更新" class="header-anchor">#</a> 2. 电子商务数据模型中的更新</h3> <h4 id="冗余字段设计"><a href="#冗余字段设计" class="header-anchor">#</a> 冗余字段设计</h4> <p>对于一些常见的结果，比如：总数、平均值等。为了避免每次都<strong>重新聚合运算</strong>，可以在文档中<strong>保存额外的字段缓存</strong>相关数据。</p> <p>之后的业务查询，仅仅需要查询一次即可。</p> <h4 id="操作符"><a href="#操作符" class="header-anchor">#</a> <code>$</code>操作符</h4> <p>作用：确定数组中一个要被更新的元素的位置，而不用具体指定该元素在数组中的位置。</p> <p>如下所示，不需要知道在 grades 数组中匹配的具体位置，用<code>$</code>指代即可：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;grades&quot;</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">80</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> db<span class="token punctuation">.</span>students<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
   <span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> grades<span class="token operator">:</span> <span class="token number">80</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> $set<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;grades.$&quot;</span> <span class="token operator">:</span> <span class="token number">82</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="upsert操作符"><a href="#upsert操作符" class="header-anchor">#</a> <code>upsert</code>操作符</h4> <p>作用：如果不存在，则会自动<code>insert</code>。</p> <p>对于添加到商品到购物车等场景，非常适用。</p> <h3 id="_3-事务性工作流"><a href="#_3-事务性工作流" class="header-anchor">#</a> 3. 事务性工作流</h3> <p>这里主要使用的是<code>findAndModify</code>命令。这个命令，支持传入 query 参数，来做匹配筛选；支持 update，来做针对性更新（原子更新）。最重要的特性是：<strong>可以根据<code>new</code>参数，来返回更新前后的文档数据状态</strong>。</p> <p>借助可以返回更新文档数据的特性，可以 mock 一下 mongo 4.0 之前不支持的事务特性。思路是：</p> <ol><li>获取最初的文档数据</li> <li>利用 findAndModify 进行针对性更新，更新字段中需要携带本次的更新标示（比如时间戳）。findAndModify 操作符回返回更新后的字段。</li> <li>将更新后的字段中的更新标示与本地保存的标示做对比，如果不相同，说明有别的端更新了数据，数据发生了污染，为了保证事务原子性的特点，将文档恢复为第 1 步获得原始数据；如果相同，那么继续进行。</li></ol> <p>在 MongoDB 4.0 中，就是通过类似第二步的思路，提供了一个 seesionID 来实现了事务的，保证了事务特性。</p> <h3 id="_4-更多的更新命令"><a href="#_4-更多的更新命令" class="header-anchor">#</a> 4. 更多的更新命令</h3> <p>update：multi 参数不给，默认只更新匹配到的第一个文档。</p> <p>unset：删除文档中的指定键。</p> <p>rename：重命名键。</p> <p>addToSet：数组中不存在时候，才会加入。</p> <p>pull：删除数组指定位置的元素。</p> <h3 id="_5-更新本质和优化"><a href="#_5-更新本质和优化" class="header-anchor">#</a> 5. 更新本质和优化</h3> <p>更新分为 3 种：</p> <ul><li>只改变单值，但 BSON 文档不变：<code>$inc</code>操作符</li> <li>改变文档和结构，会重写整个文档：<code>$push</code></li> <li>改变文档造成空间不够，全部整体迁移到新空间：提前利用<strong>填充因子</strong>来减少影响</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dongyuanxin/blog/edit/master/notes/07.数据库/3.mongodb/1.基础、编码和优化.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">9/21/2020, 5:25:11 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/2.mysql/2.%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/" class="prev">
        数据恢复
      </a></span> <span class="next"><a href="/notes/07.数据库/3.mongodb/2.进阶：索引、复制和分片.html">
        进阶：索引、复制和分片
      </a>
      →
    </span></p></div> <aside class="right-sidebar"><div class="right-sidebar-links"><div class="right-sidebar-header">关注公众号</div> <img src="https://tva1.sinaimg.cn/large/006tNbRwly1gaknn8mr5ej3076076aaj.jpg" alt="公众号搜索：心谭博客" srcset></div> <div class="right-sidebar-links"><div class="right-sidebar-header">
            本文目录
        </div> <div><ul><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#mongodb-特性和介绍">MongoDB 特性和介绍</a><ul><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_1-简介">1. 简介</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_2-主要特性">2. 主要特性</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_3-核心服务器和工具">3. 核心服务器和工具</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_4-mongo-的场景">4. Mongo 的场景</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_5-局限">5. 局限</a></li></ul></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#程序编写基础">程序编写基础</a><ul><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_1-驱动工作原理">1. 驱动工作原理</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_2-安全写入模式-write-concern">2. 安全写入模式(Write Concern)</a></li></ul></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#面向文档的数据">面向文档的数据</a><ul><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_1-schema-设计原则">1. Schema 设计原则</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_2-设计电子商务数据模型">2. 设计电子商务数据模型</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_3-具体细节">3. 具体细节</a></li></ul></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#查询和聚合">查询和聚合</a><ul><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_1-查询常见技巧">1. 查询常见技巧</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_2-常见查询语言">2. 常见查询语言</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_3-查询选项">3. 查询选项</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_4-聚合指令">4. 聚合指令</a></li></ul></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#更新、原子操作与删除">更新、原子操作与删除</a><ul><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_1-文档更新入门">1. 文档更新入门</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_2-电子商务数据模型中的更新">2. 电子商务数据模型中的更新</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_3-事务性工作流">3. 事务性工作流</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_4-更多的更新命令">4. 更多的更新命令</a></li><li><a href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/3.mongodb/1.%E5%9F%BA%E7%A1%80%E3%80%81%E7%BC%96%E7%A0%81%E5%92%8C%E4%BC%98%E5%8C%96.html#_5-更新本质和优化">5. 更新本质和优化</a></li></ul></li></ul></div></div> <div class="right-sidebar-links"><div class="right-sidebar-header">
            最近更新
            <a href="/guide/" target="_blank">&gt;&gt;&gt;查看全部</a></div> <div class="right-sidebar-item"><a target="_blank" href="/notes/09.Node%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1/02.KoaJS/02.KoaJS%EF%BC%9A%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B/" title="is-generator-function：判断 generator">is-generator-function：判断 generator</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/1.%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB/1.%E9%94%81%E6%9C%BA%E5%88%B6/" title="乐观锁">乐观锁</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/1.%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB/2.%E8%AF%BB%E5%86%99%E5%BC%82%E5%B8%B8/" title="场景">场景</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/07.%E6%95%B0%E6%8D%AE%E5%BA%93/1.%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB/3.%E9%9A%94%E7%A6%BB%E6%9C%BA%E5%88%B6/" title="快照隔离">快照隔离</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/09.Node%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1/16.%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/04.SSO/" title="SSO: Signgle Sign On">SSO: Signgle Sign On</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/09.Node%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1/16.%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/03.Token/01.JWT/" title="JSON Web Token">JSON Web Token</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/09.Node%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1/16.%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/03.Token/" title="为什么需要 Token？">为什么需要 Token？</a></div><div class="right-sidebar-item"><a target="_blank" href="/notes/09.Node%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1/15.%E6%9C%8D%E5%8A%A1%E6%80%A7%E8%83%BD/02.%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" title="场景">场景</a></div></div></aside> </main></div><div class="global-ui"><div class="my-loader center" style="display:none;" data-v-354e1a9e><div class="my-loader-circle" data-v-354e1a9e></div></div><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div><!----><!----><div></div></div></div>
    <script src="/assets/js/app.f478fbae.js" defer></script><script src="/assets/js/2.698e7189.js" defer></script><script src="/assets/js/3.9966209a.js" defer></script><script src="/assets/js/229.a56affd6.js" defer></script><script src="/assets/js/5.51d45416.js" defer></script>
  </body>
</html>
